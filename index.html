<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tableau de bord — ISS · Horloge · Page du jour (FR)</title>

  <!-- Font (Inter-like) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS (sans integrity pour éviter blocage SRI) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#111827;
      --glass: rgba(255,255,255,0.7);
      --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --accent-2: #2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--accent);background:var(--bg)}
    /* Layout */
    .wrap{max-width:1200px;margin:28px auto;padding:20px;display:grid;grid-template-columns:260px 1fr;gap:20px}
    /* Sidebar (notion style) */
    .sidebar{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:fit-content}
    .brand{font-weight:700;font-size:16px;margin-bottom:6px}
    .subtitle{font-size:12px;color:var(--muted);margin-bottom:12px}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav a{display:block;padding:8px;border-radius:8px;color:var(--accent-2);text-decoration:none;font-weight:600}
    .nav a:hover{background:#f1f5f9}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    .grid-main{display:grid;grid-template-columns:1fr 420px;gap:20px}
    .top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    /* Map */
    #map{height:340px;border-radius:10px;overflow:hidden;border:1px solid rgba(2,6,23,0.04)}
    .iss-info{margin-top:10px;font-size:14px;color:var(--muted)}
    /* Clock column */
    .clock-box{display:flex;gap:14px;align-items:center}
    canvas{background:transparent;border-radius:8px}
    .clock-meta{display:flex;flex-direction:column}
    .digital{font-size:18px;font-weight:700}
    .date{font-size:13px;color:var(--muted)}
    /* Wiki */
    .wiki-title{display:flex;justify-content:space-between;align-items:center}
    .wiki-list{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .wiki-item{padding:12px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid rgba(2,6,23,0.04)}
    .wiki-item h3{margin:0 0 6px 0;font-size:15px}
    .wiki-item p{margin:0;color:var(--muted);font-size:14px}
    .links-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .link-pill{padding:8px 10px;border-radius:8px;background:#f8fafc;border:1px solid rgba(2,6,23,0.04);font-weight:600;color:var(--accent-2);text-decoration:none}
    footer{grid-column:1/3;text-align:center;color:var(--muted);font-size:13px;margin-top:18px}
    @media (max-width:980px){
      .wrap{padding:12px;grid-template-columns:1fr;gap:12px}
      .grid-main{grid-template-columns:1fr;align-items:stretch}
      #map{height:260px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar">
      <div class="brand">Notion-like Dashboard</div>
      <div class="subtitle">ISS · Horloge · Page du jour (FR)</div>

      <nav class="nav">
        <a href="#iss">ISS — Position</a>
        <a href="#clock">Horloge</a>
        <a href="#wiki">Wiki du jour</a>
      </nav>

      <div style="height:12px"></div>

      <div class="muted" style="font-size:13px">Liens rapides</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <a class="link-pill" href="https://www.nasa.gov/" target="_blank">NASA</a>
        <a class="link-pill" href="https://www.esa.int/" target="_blank">ESA</a>
        <a class="link-pill" href="https://fr.wikipedia.org/" target="_blank">Wikipédia FR</a>
        <a class="link-pill" href="https://heavens-above.com/" target="_blank">Heavens-Above</a>
      </div>
    </aside>

    <main>
      <div class="card">
        <div class="top-row">
          <div>
            <h1 id="title">Tableau de bord spatial</h1>
            <div class="muted">Suivi en temps réel de l'ISS · Horloge analogique · Page Wikipédia du jour (FR)</div>
          </div>
          <div class="muted">Mise à jour ISS toutes les 5s</div>
        </div>

        <div class="grid-main">
          <!-- left column -->
          <div>
            <section id="iss" class="card" style="margin-bottom:16px">
              <h2 style="margin:0 0 10px 0">Position actuelle de l'ISS</h2>
              <div id="map"></div>
              <div class="iss-info" id="iss-info">Chargement...</div>
            </section>

            <section class="card">
              <h2 style="margin:0 0 8px 0">Liens utiles</h2>
              <div class="links-row">
                <a class="link-pill" href="https://www.spacex.com/" target="_blank">SpaceX</a>
                <a class="link-pill" href="https://spotthestation.nasa.gov/" target="_blank">Spot the Station</a>
                <a class="link-pill" href="https://timeanddate.com" target="_blank">Time & Date</a>
              </div>
            </section>
          </div>

          <!-- right column -->
          <aside>
            <section id="clock" class="card" style="margin-bottom:16px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <h2 style="margin:0">Horloge</h2>
                <div class="muted" id="clock-zone">Europe/Paris</div>
              </div>
              <div style="margin-top:12px;display:flex;align-items:center;gap:12px">
                <canvas id="analogClock" width="220" height="220"></canvas>
                <div class="clock-meta">
                  <div class="digital" id="digitalTime">--:--:--</div>
                  <div class="date" id="digitalDate">—</div>
                  <div style="height:8px"></div>
                  <div class="muted" style="font-size:13px">Chiffres autour du cadran</div>
                </div>
              </div>
            </section>

            <section id="wiki" class="card">
              <div class="wiki-title">
                <h2 style="margin:0">Page du jour — Wikipédia (FR)</h2>
                <div class="muted" id="wiki-date">—</div>
              </div>
              <div id="wiki-container" class="wiki-list" style="margin-top:10px">
                <div class="wiki-item">Chargement…</div>
              </div>
            </section>
          </aside>
        </div>
      </div>

      <footer>Page autonome — données publiques · Leaflet · Wikipédia FR · Open-Notify</footer>
    </main>
  </div>

  <!-- Leaflet JS (sans integrity) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ----------------------------
    // ISS Tracking (Leaflet)
    // ----------------------------
    const map = L.map('map', {zoomControl: true}).setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const issIcon = L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/d/d0/International_Space_Station.svg',
      iconSize: [48, 32],
      iconAnchor: [24, 16]
    });

    const issMarker = L.marker([0,0], {icon: issIcon}).addTo(map);
    const issPolyline = L.polyline([], {color: '#2563eb', weight: 3, opacity: 0.9}).addTo(map);
    const trackPoints = [];

    async function fetchISS() {
      try {
        const res = await fetch('https://api.wheretheiss.at/v1/satellites/25544'); // rich response
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const d = await res.json();
        const lat = d.latitude;
        const lon = d.longitude;
        const alt = d.altitude ? Number(d.altitude).toFixed(1) : '—';
        const vel = d.velocity ? (d.velocity*3.6).toFixed(0) : '—'; // m/s -> km/h
        const ts = d.timestamp ? new Date(d.timestamp*1000) : new Date();

        issMarker.setLatLng([lat,lon]);
        trackPoints.push([lat,lon]);
        if (trackPoints.length > 200) trackPoints.shift();
        issPolyline.setLatLngs(trackPoints);

        // Pan smoothly only if zoomed out
        if (map.getZoom() < 6) map.panTo([lat,lon], {animate:true, duration:0.6});

        document.getElementById('iss-info').innerHTML = `
          <div style="display:flex;justify-content:space-between"><div>Latitude</div><div><strong>${lat.toFixed(4)}</strong></div></div>
          <div style="display:flex;justify-content:space-between"><div>Longitude</div><div><strong>${lon.toFixed(4)}</strong></div></div>
          <div style="display:flex;justify-content:space-between"><div>Altitude (km)</div><div>${alt}</div></div>
          <div style="display:flex;justify-content:space-between"><div>Vitesse (km/h)</div><div>${vel}</div></div>
          <div style="margin-top:6px;font-size:12px;color:var(--muted)">Dernière MAJ: ${ts.toLocaleString('fr-FR')}</div>
        `;
      } catch(err) {
        console.error('ISS fetch error', err);
        document.getElementById('iss-info').textContent = 'Impossible de récupérer la position ISS — vérifie ta connexion.';
      }
    }
    fetchISS();
    setInterval(fetchISS, 5000);


    // ----------------------------
    // Analog clock (Canvas)
    // ----------------------------
    const canvas = document.getElementById('analogClock');
    const ctx = canvas.getContext('2d');
    const size = canvas.width;
    const cx = size/2, cy = size/2, R = size*0.42;
    // center transform
    ctx.translate(cx, cy);

    function drawClockFrame(){
      // background
      ctx.beginPath();
      ctx.fillStyle = '#ffffff';
      ctx.arc(0,0,R+16,0,Math.PI*2);
      ctx.fill();

      // outer ring
      ctx.beginPath();
      ctx.lineWidth = 4;
      ctx.strokeStyle = '#e6eef8';
      ctx.arc(0,0,R,0,Math.PI*2);
      ctx.stroke();

      // numbers
      ctx.fillStyle = '#111827';
      ctx.font = '14px Inter, Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (let n=1; n<=12; n++){
        const ang = (n/12)*Math.PI*2 - Math.PI/2;
        const x = Math.cos(ang)*(R-28);
        const y = Math.sin(ang)*(R-28);
        ctx.fillText(String(n), x, y);
      }
      // ticks
      for (let i=0;i<60;i++){
        const ang = (i/60)*Math.PI*2 - Math.PI/2;
        const inner = R-12;
        const outer = inner + (i%5===0?10:5);
        ctx.beginPath();
        ctx.moveTo(Math.cos(ang)*inner, Math.sin(ang)*inner);
        ctx.lineTo(Math.cos(ang)*outer, Math.sin(ang)*outer);
        ctx.lineWidth = (i%5===0?3:1);
        ctx.strokeStyle = '#e6eef8';
        ctx.stroke();
      }
    }

    function drawHands(){
      const now = new Date();
      const sec = now.getSeconds() + now.getMilliseconds()/1000;
      const min = now.getMinutes() + sec/60;
      const hr = (now.getHours()%12) + min/60;

      // clear face area
      ctx.clearRect(-size/2, -size/2, size, size);

      drawClockFrame();

      // hour
      drawHand((hr/12)*Math.PI*2 - Math.PI/2, R*0.5, 6, '#111827');
      // minute
      drawHand((min/60)*Math.PI*2 - Math.PI/2, R*0.75, 4, '#111827');
      // second
      drawHand((sec/60)*Math.PI*2 - Math.PI/2, R*0.88, 2, '#ef4444');

      // center dot
      ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fillStyle = '#2563eb'; ctx.fill();

      // update digital
      document.getElementById('digitalTime').textContent = now.toLocaleTimeString('fr-FR');
      document.getElementById('digitalDate').textContent = now.toLocaleDateString('fr-FR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    }

    function drawHand(angle, length, width, color){
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineWidth = width;
      ctx.lineCap = 'round';
      ctx.strokeStyle = color;
      ctx.rotate(angle);
      ctx.lineTo(0, -length);
      ctx.stroke();
      ctx.rotate(-angle);
    }

    // initial draw + interval
    drawHands();
    setInterval(drawHands, 200);


    // ----------------------------
    // Page du jour — Wikipédia FR
    // Attempt: fetch "featured" article from fr.wikipedia - fallback to onthisday
    // ----------------------------
    async function fetchWikiFR(){
      const container = document.getElementById('wiki-container');
      const dateLabel = document.getElementById('wiki-date');
      container.innerHTML = '<div class="wiki-item">Chargement…</div>';
      try {
        const now = new Date();
        const Y = now.getFullYear();
        const M = String(now.getMonth()+1).padStart(2,'0');
        const D = String(now.getDate()).padStart(2,'0');

        // 1) Try featured feed (tentaive). Structure may vary across languages/versions.
        let urlFeatured = `https://fr.wikipedia.org/api/rest_v1/feed/featured/${Y}/${M}/${D}`;
        let resp = await fetch(urlFeatured);
        if (resp.ok){
          const data = await resp.json();
          // different feeds may include 'tfa' (today's featured article) or 'mostread' or 'featured'
          // We try several common keys
          let article = null;

          if (data.tfa) article = data.tfa;
          else if (data.featured && data.featured.title) article = data.featured;
          else if (data.featured && data.featured['original']) article = data.featured['original'];
          else if (data.lead && data.lead.displaytitle) article = data.lead;
          else if (data.top && data.top.title) article = data.top;

          if (article && (article.title || article.displaytitle || article.normalizedtitle)) {
            // build a display from available fields
            const title = article.title || article.displaytitle || article.normalizedtitle || 'Article du jour';
            const extract = article.extract || article.description || (article.display && article.display.text) || '';
            // link: try to use content_urls.desktop.page if present, else fallback to wiki url
            const link = (article.content_urls && article.content_urls.desktop && article.content_urls.desktop.page) ? article.content_urls.desktop.page
                          : `https://fr.wikipedia.org/wiki/${encodeURIComponent(title.replace(/\s+/g, '_'))}`;

            container.innerHTML = `
              <div class="wiki-item">
                <h3><a href="${link}" target="_blank" rel="noopener">${title}</a></h3>
                <p>${extract ? escapeHtml(extract) : "Aperçu non disponible — clique pour lire l'article."}</p>
              </div>
            `;
            dateLabel.textContent = now.toLocaleDateString('fr-FR', {day:'numeric', month:'long', year:'numeric'});
            return;
          }
        }

        // 2) Fallback: onthisday (événements). Prefer fr.wikipedia's onthisday
        let urlOnThis = `https://fr.wikipedia.org/api/rest_v1/feed/onthisday/all/${M}/${D}`;
        resp = await fetch(urlOnThis);
        if (resp.ok){
          const data = await resp.json();
          const items = [];
          if (data.events) items.push(...data.events);
          if (data.births) items.push(...data.births);
          if (data.deaths) items.push(...data.deaths);

          if (items.length){
            // pick first item with a page reference
            const it = items[0];
            const title = it.text || (it.pages && it.pages[0] && it.pages[0].normalizedtitle) || 'Événement du jour';
            // link prefer pages[0].content_urls.desktop.page
            const link = (it.pages && it.pages[0] && it.pages[0].content_urls && it.pages[0].content_urls.desktop && it.pages[0].content_urls.desktop.page)
                          ? it.pages[0].content_urls.desktop.page
                          : `https://fr.wikipedia.org/wiki/${encodeURIComponent(title.replace(/\s+/g,'_'))}`;
            const year = it.year ? `${it.year} — ` : '';
            container.innerHTML = `
              <div class="wiki-item">
                <h3><a href="${link}" target="_blank" rel="noopener">${year}${escapeHtml(title)}</a></h3>
                <p>${escapeHtml(it.text || (it.pages && it.pages[0] && it.pages[0].extract) || '')}</p>
              </div>
            `;
            dateLabel.textContent = now.toLocaleDateString('fr-FR', {day:'numeric', month:'long', year:'numeric'});
            return;
          }
        }

        // 3) If all fails
        container.innerHTML = '<div class="wiki-item">Aucune donnée disponible pour aujourd\'hui.</div>';
        dateLabel.textContent = now.toLocaleDateString('fr-FR');
      } catch (err) {
        console.error('Wiki fetch error', err);
        container.innerHTML = '<div class="wiki-item">Impossible de charger la page du jour — vérifie ta connexion.</div>';
      }
    }

    // small helper to avoid HTML injection in strings rendered as text
    function escapeHtml(str){
      if(!str) return '';
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    fetchWikiFR();


    // Accessibility: allow clicking nav links to scroll smoothly
    document.querySelectorAll('.nav a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const target = document.querySelector(a.getAttribute('href'));
        if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });
  </script>
</body>
</html>
